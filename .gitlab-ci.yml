stages:
  - Build
  - Package

before_script:
  - export BASE_URL=${BASE_URL:-$(echo $CI_PROJECT_URL |  cut -d'/' -f1-3)}
  - export CI_COMMIT_SHA_SHORT=$(echo ${CI_COMMIT_SHA} | cut -c -8)

compile:
  stage: Build
  image: "ruby:2.4.1"
  script:
    - ruby -v                                   # Print out ruby version for debugging
    - gem install bundler  --no-ri --no-rdoc    # Bundler is not installed with the image
    - bundle install -j $(nproc) --path vendor  # Install dependencies into ./vendor/ruby
    - bundle exec rake build
    - mv pkg/*gem .

  artifacts:
    name: "${CI_JOB_NAME}_${CI_COMMIT_REF_NAME}"
    untracked: true
    expire_in: 4 weeks
    paths:
      - "*gem"
      - "vendor"
      - Gemfile.lock

container:
  stage: Package
  image: docker:latest
  dependencies: 
    - compile
  script:
    - apk update && apk add curl jq git make
    - mkdir ./fluentd-base ; git clone https://github.com/denverwilliams/fluentd-docker-image.git -b cross-cloud ./fluentd-base
    - cp -a ./vendor ./fluentd-base/v1.0/alpine/ ; cp ./fluent*.gem ./fluentd-base/v1.0/alpine/fluent.gem ; cp ./Gemfile ./fluentd-base/v1.0/alpine/Gemfile ; cp ./Gemfile.lock ./fluentd-base/v1.0/alpine/Gemfile.lock
    - cd ./fluentd-base ; make image IMAGE_NAME="$CI_REGISTRY_IMAGE" DOCKERFILE=v1.0/alpine VERSION="$CI_COMMIT_SHA" ; cd -
    - mkdir ./fluentd-daemonset ; git clone https://github.com/denverwilliams/fluentd-kubernetes-daemonset.git -b cross-cloud ./fluentd-daemonset
    - cd ./fluentd-daemonset ; make image BASE_IMAGE="$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA" IMAGE_NAME="$CI_REGISTRY_IMAGE/daemonset" DOCKERFILE=v0.12/cloudwatch VERSION="$CI_COMMIT_SHA" ; cd -
    - echo export IMAGE=$CI_REGISTRY_IMAGE/daemonset | tee release.env
    - echo export TAG=$CI_COMMIT_SHA | tee -a release.env
    - cat release.env

  artifacts:
    name: "${CI_JOB_NAME}_${CI_COMMIT_REF_NAME}"
    untracked: true
    expire_in: 4 weeks
    paths:
      - release.env
